<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Order X Link Post Engagement</title>

<style>
/* ==================== BASE UI ==================== */

body {
    font-family: Arial, sans-serif;
    background: #eef2f7;
    margin: 0;
    padding: 0;
}

.header {
    text-align: center;
    padding: 28px;
    background: #0d6efd;
    color: white;
    font-size: 24px;
    font-weight: bold;
}

.container {
    max-width: 820px;
    margin: 28px auto;
    background: white;
    padding: 28px;
    border-radius: 14px;
    box-shadow: 0 6px 22px rgba(0,0,0,0.08);
}

.section-title {
    margin-top: 0;
    font-size: 22px;
    font-weight: bold;
}

/* ==================== POST BOX ==================== */

.post-box {
    border: 1px solid #ddd;
    background: #fafafa;
    padding: 20px;
    border-radius: 12px;
    margin-bottom: 22px;

    /* Fade-in animation */
    animation: fadeIn 0.25s ease-out;
}

.post-box:hover {
    box-shadow: 0 4px 16px rgba(0,0,0,0.08);
    transform: translateY(-2px);
    transition: 0.2s;
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(5px); }
    to { opacity: 1; transform: translateY(0); }
}

.post-box h3 {
    margin: 0 0 10px;
    font-size: 18px;
}

/* ==================== REMOVE BUTTON (NEW SVG VERSION) ==================== */

.remove-btn {
    float:right;
    background:#ff4d4f;
    border:0;
    padding:5px 10px;
    border-radius:6px;
    cursor:pointer;
    margin-top:-35px;
    display: flex;
    align-items: center;
    justify-content: center;
}

.remove-btn svg {
    width: 14px;
    height: 14px;
    fill:white;
}

/* ==================== INPUTS ==================== */

label {
    font-weight: bold;
    display: block;
    margin-top: 14px;
    font-size: 15px;
}

input[type="text"],
input[type="number"],
textarea {
    width: 100%;
    padding: 11px 12px;
    border-radius: 8px;
    border: 1px solid #ccc;
    margin-top: 6px;
    box-sizing: border-box;
    font-size: 15px;
    transition: 0.15s;
}

input:focus,
textarea:focus {
    border-color: #0d6efd;
    outline: none;
    box-shadow: 0 0 0 3px rgba(13,110,253,0.18);
}

.note-small {
    font-size: 13px;
    color: #555;
    margin-top: 6px;
}

.checkbox {
    margin-top: 14px;
    font-size: 15px;
}

/* ==================== SLIDE-DOWN ANIMATION ==================== */

.service-options {
    margin-left: 24px;
    margin-top: 12px;
    overflow: hidden;
    max-height: 0;
    transition: max-height 0.25s ease-out;
}

.service-options.show {
    max-height: 500px;
}

/* ==================== BUTTONS ==================== */

.add-post-btn {
    width: 100%;
    padding: 13px;
    background: #28a745;
    color: white;
    font-size: 17px;
    border: 0;
    border-radius: 10px;
    margin-top: 18px;
    cursor: pointer;
    font-weight: bold;
}

.submit-btn {
    width: 100%;
    padding: 15px;
    background: #0d6efd;
    color: white;
    font-size: 19px;
    border: 0;
    border-radius: 10px;
    margin-top: 30px;
    cursor: pointer;
    font-weight: bold;
}

.total-row {
    text-align: right;
    font-size: 22px;
    font-weight: bold;
    margin-top: 30px;
    background: #f1f5ff;
    padding: 12px 16px;
    border-radius: 10px;
}

.footer {
    text-align: center;
    color: #777;
    margin: 38px 0 20px;
    font-size: 13px;
}
</style>
</head>

<body>

<div class="header">Order X Link Post Engagement</div>

<div class="container">

    <h2 class="section-title">Your Post Links</h2>

    <div id="posts_wrapper"></div>

    <button class="add-post-btn" onclick="addPostBox()">Add Another Post Link</button>

    <div class="total-row">
        Total: <span id="total_price">0.00</span> USD
    </div>

    <label>Email</label>
    <input type="text" id="contact" placeholder="you@example.com">

    <label>Note (Optional)</label>
    <textarea id="note" rows="3"></textarea>

    <p class="note-small">
        If you need cheaper bundles, full engagement packages or have any questions, 
        please contact Telegram/X: <b>shuigvn</b> or <b>howhitening</b>.
    </p>

    <div style="margin-top:20px;">
        <div class="cf-turnstile"
            data-sitekey="0x4AAAAAACFbLkLsJZF9dyHE"
            data-callback="turnstileDone"
            id="turnstile-widget">
        </div>
    </div>

    <button class="submit-btn" onclick="submitOrder()">Create Order</button>
</div>

<div class="footer">Website created by Toridochi</div>

<!-- ==================== JS ==================== -->

<script>
let turnstileToken = "";

function turnstileDone(token) {
    turnstileToken = token;
}

let postCount = 0;

/* ==================== ADD POST BOX ==================== */

function addPostBox() {
    postCount++;

    const div = document.createElement("div");
    div.className = "post-box";
    div.id = "post_" + postCount;

    div.innerHTML = `
        <h3>Post #${postCount}</h3>

        <button class="remove-btn" onclick="removePost(${postCount})">
            <svg viewBox="0 0 448 512">
                <path d="M135.2 17.7c2.7-10.7 12.4-17.7 23.4-17.7h130.9c11 
                0 20.7 7 23.4 17.7L328 32H432c8.8 0 16 7.2 
                16 16s-7.2 16-16 16h-16l-21.2 
                372.3c-1.5 26.5-23.5 47.7-50 
                47.7H103.2c-26.6 
                0-48.5-21.2-50-47.7L32 
                64H16C7.2 64 0 56.8 0 
                48s7.2-16 16-16H120l15.2-14.3z"/>
            </svg>
        </button>

        <div style="clear:both;"></div>

        <label>Post Link</label>
        <input type="text" id="link_${postCount}" placeholder="https://x.com/...">

        <!-- VIEWS -->
        <div class="checkbox">
            <input type="checkbox" id="view_${postCount}" onchange="toggleService(${postCount}, 'view')"> Views
        </div>
        <div id="view_wrap_${postCount}" class="service-options">
            <label>Number of Views</label>
            <input type="number" id="view_amount_${postCount}" min="5000" value="5000" 
                oninput="validateMin(${postCount}, 'view'); updateTotal();">
            <div class="note-small" id="view_note_${postCount}">
                5000 views = $1. +1000 = $0.2
            </div>
        </div>

        <!-- COMMENTS -->
        <div class="checkbox">
            <input type="checkbox" id="comment_${postCount}" onchange="toggleService(${postCount}, 'comment')"> Comments
        </div>
        <div id="comment_wrap_${postCount}" class="service-options">
            <label>Number of Comments</label>
            <input type="number" id="comment_amount_${postCount}" min="10" value="10" 
                oninput="validateMin(${postCount}, 'comment'); updateTotal();">
            <div class="note-small" id="comment_note_${postCount}">
                10 comments = $3. +1 = $0.3<br>
                <b>Comments come from verified accounts, and the content will be reasonably relevant to your post.</b>
            </div>
        </div>

        <!-- LIKES -->
        <div class="checkbox">
            <input type="checkbox" id="like_${postCount}" onchange="toggleService(${postCount}, 'like')"> Likes
        </div>
        <div id="like_wrap_${postCount}" class="service-options">
            <label>Number of Likes</label>
            <input type="number" id="like_amount_${postCount}" min="100" value="100" 
                oninput="validateMin(${postCount}, 'like'); updateTotal();">
            <div class="note-small" id="like_note_${postCount}">
                100 likes = $2. +10 = $0.2
            </div>
        </div>

        <!-- COMBO -->
        <div class="checkbox">
            <input type="checkbox" id="combo_${postCount}" onchange="toggleService(${postCount}, 'combo')"> 
            Combo (300 likes + 30 comments + 3000 views)
        </div>
        <div id="combo_wrap_${postCount}" class="service-options">
            <label>Number of Combos</label>
            <input type="number" id="combo_amount_${postCount}" min="1" value="1" 
                oninput="validateMin(${postCount}, 'combo'); updateTotal();">
            <div class="note-small" id="combo_note_${postCount}">
                Each combo includes 300 likes, 30 comments, 3000 views from verified accounts.<br>
                Price: $14 per combo
            </div>
        </div>
    `;

    document.getElementById("posts_wrapper").appendChild(div);

    /* Auto-focus */
    document.getElementById(`link_${postCount}`).focus();

    updateTotal();
}

/* Render the first box */
addPostBox();

/* ==================== SERVICE TOGGLE (SLIDE DOWN) ==================== */

function toggleService(id, type) {
    const elem = document.getElementById(`${type}_wrap_${id}`);
    if (document.getElementById(`${type}_${id}`).checked) {
        elem.classList.add("show");
    } else {
        elem.classList.remove("show");
    }
    updateTotal();
}

/* ==================== AUTO FORMAT LINK ==================== */
document.addEventListener("input", function(e){
    if (e.target.id.startsWith("link_")) {
        let val = e.target.value.trim();

        if (val.startsWith("x.com") || val.startsWith("twitter.com")) {
            e.target.value = "https://" + val;
        }

        if (val.startsWith("www.")) {
            e.target.value = "https://" + val.slice(4);
        }
    }
});

/* ==================== VALIDATION ==================== */

function validateMin(id, type) {
    const input = document.getElementById(`${type}_amount_${id}`);
    const note = document.getElementById(`${type}_note_${id}`);
    const value = parseInt(input.value || 0);

    const MIN = { view: 5000, comment: 10, like: 100, combo: 1 };

    if (value < MIN[type]) {
        input.style.border = "2px solid red";
        note.style.color = "red";
        note.innerText = `Minimum is ${MIN[type]}`;
        return false;
    }

    input.style.border = "1px solid #ccc";
    note.style.color = "#555";
    return true;
}

/* ==================== TOTAL PRICE ==================== */

function updateTotal() {
    let total = 0;

    for (let i = 1; i <= postCount; i++) {
        if (!document.getElementById(`post_${i}`)) continue;

        if (document.getElementById(`view_${i}`).checked) {
            let v = parseInt(document.getElementById(`view_amount_${i}`).value);
            if (v >= 5000) total += 1 + ((v - 5000) / 1000) * 0.2;
        }

        if (document.getElementById(`comment_${i}`).checked) {
            let c = parseInt(document.getElementById(`comment_amount_${i}`).value);
            if (c >= 10) total += 3 + (c - 10) * 0.3;
        }

        if (document.getElementById(`like_${i}`).checked) {
            let l = parseInt(document.getElementById(`like_amount_${i}`).value);
            if (l >= 100) total += 2 + ((l - 100) / 10) * 0.2;
        }

        if (document.getElementById(`combo_${i}`).checked) {
            let cb = parseInt(document.getElementById(`combo_amount_${i}`).value);
            if (cb >= 1) total += cb * 14;
        }
    }

    document.getElementById("total_price").innerText = total.toFixed(2);
    return total;
}

/* ==================== SUBMIT ORDER ==================== */

async function submitOrder() {
    if (!turnstileToken) {
        alert("Please verify you are human.");
        return;
    }

    const contact = document.getElementById("contact").value.trim();

    // Validate email
    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    if (!emailRegex.test(contact)) {
        alert("Please enter a valid email address.");
        document.getElementById("contact").style.border = "2px solid red";
        return;
    }

    const twitterRegex = /^https?:\/\/(x|twitter)\.com\/([A-Za-z0-9_]{1,50})\/status\/(\d+)$/;

    let posts = [];

    for (let i = 1; i <= postCount; i++) {
        const box = document.getElementById(`post_${i}`);
        if (!box) continue;

        const linkField = document.getElementById(`link_${i}`);
        const link = linkField.value.trim();

        if (!twitterRegex.test(link)) {
            alert(`Post #${i}: Invalid X/Twitter post URL.`);
            linkField.style.border = "2px solid red";
            return;
        }

        const hasService =
            document.getElementById(`view_${i}`).checked ||
            document.getElementById(`comment_${i}`).checked ||
            document.getElementById(`like_${i}`).checked ||
            document.getElementById(`combo_${i}`).checked;

        if (!hasService) {
            alert(`Post #${i}: You must select at least one service.`);
            return;
        }

        posts.push({
            link,
            views: document.getElementById(`view_${i}`).checked 
                ? parseInt(document.getElementById(`view_amount_${i}`).value) : 0,
            comments: document.getElementById(`comment_${i}`).checked 
                ? parseInt(document.getElementById(`comment_amount_${i}`).value) : 0,
            likes: document.getElementById(`like_${i}`).checked 
                ? parseInt(document.getElementById(`like_amount_${i}`).value) : 0,
            combo: document.getElementById(`combo_${i}`).checked 
                ? { count: parseInt(document.getElementById(`combo_amount_${i}`).value), price: 14 }
                : null
        });
    }

    const userNote = document.getElementById("note").value.trim();

    const body = {
        post_link: "MULTI",
        package: "multi",
        contact,
        note: {
            user_note: userNote || null,
            posts: posts
        },
        price: updateTotal(),
        turnstile: turnstileToken
    };

    const res = await fetch("/api/orders/create", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(body)
    });

    const data = await res.json();

    window.location.href =
        `/payment.html?id=${data.order.id}&t=${data.order.public_token}&amount=${data.order.price}`;
}

/* ==================== REMOVE POST ==================== */

function removePost(id) {
    if (id === 1) {
        alert("Post #1 cannot be removed.");
        return;
    }

    const postBox = document.getElementById(`post_${id}`);
    if (postBox) {
        postBox.remove();
        updateTotal();
    }
}
</script>

<script src="https://challenges.cloudflare.com/turnstile/v0/api.js" async defer></script>

</body>
</html>
