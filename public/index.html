<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Order X Link Post Engagement</title>

<style>
body {
    font-family: Arial, sans-serif;
    background: #eef2f7;
    margin: 0;
    padding: 0;
}

.header {
    text-align: center;
    padding: 25px;
    background: #0d6efd;
    color: white;
    font-size: 24px;
    font-weight: bold;
}

.container {
    max-width: 780px;
    margin: 25px auto;
    background: white;
    padding: 25px;
    border-radius: 14px;
    box-shadow: 0 6px 22px rgba(0,0,0,0.08);
}

.section-title {
    margin-top: 0;
    font-size: 20px;
    font-weight: bold;
}

.post-box {
    border: 1px solid #ddd;
    background: #fafafa;
    padding: 18px;
    border-radius: 10px;
    margin-bottom: 20px;
}

.post-box h3 {
    margin-top: 0;
}

label {
    font-weight: bold;
    display: block;
    margin-top: 12px;
}

input[type="text"],
input[type="number"],
textarea {
    width: 100%;
    padding: 10px;
    border-radius: 8px;
    border: 1px solid #ccc;
    margin-top: 5px;
}

.note-small {
    font-size: 13px;
    color: #555;
    margin-top: 4px;
}

.checkbox {
    margin-top: 14px;
}

.service-options {
    margin-left: 22px;
    margin-top: 10px;
}

.total-row {
    text-align: right;
    font-size: 20px;
    font-weight: bold;
    margin-top: 25px;
}

.add-post-btn {
    width: 100%;
    padding: 12px;
    background: #28a745;
    color: white;
    font-size: 16px;
    border: 0;
    border-radius: 8px;
    margin-top: 15px;
    cursor: pointer;
}

.submit-btn {
    width: 100%;
    padding: 14px;
    background: #0d6efd;
    color: white;
    font-size: 18px;
    border: 0;
    border-radius: 8px;
    margin-top: 25px;
    cursor: pointer;
}

.footer {
    text-align: center;
    color: #777;
    margin: 35px 0 20px;
    font-size: 13px;
}
</style>
</head>

<body>

<div class="header">Order X Link Post Engagement</div>

<div class="container">

    <h2 class="section-title">Your Post Links</h2>

    <div id="posts_wrapper"></div>

    <button class="add-post-btn" onclick="addPostBox()">Add Another Post Link</button>

    <div class="total-row">
        Total: <span id="total_price">0.00</span> USD
    </div>

    <label>Contact (Email or X handle)</label>
    <input type="text" id="contact">

    <label>Note (Optional)</label>
    <textarea id="note"></textarea>

    <p class="note-small">
        If you need cheaper bundles, full engagement packages or have any questions, 
        please contact Telegram/X: <b>shuigvn</b> or <b>howhitening</b>.
    </p>

    <button class="submit-btn" onclick="submitOrder()">Create Order</button>
</div>

<div class="footer">Website created by Toridochi</div>


<script>
let postCount = 0;

function addPostBox() {
    postCount++;

    const div = document.createElement("div");
    div.className = "post-box";
    div.id = "post_" + postCount;

    div.innerHTML = `
        <h3>Post #${postCount}</h3>

        <label>Post Link</label>
        <input type="text" id="link_${postCount}" placeholder="https://x.com/...">

        <!-- VIEWS -->
        <div class="checkbox">
            <input type="checkbox" id="view_${postCount}" onchange="toggleService(${postCount}, 'view')"> Views
        </div>
        <div id="view_wrap_${postCount}" class="service-options" style="display:none;">
            <label>Number of Views</label>
            <input type="number" id="view_amount_${postCount}" min="5000" value="5000" 
                oninput="validateMin(${postCount}, 'view'); updateTotal();">
            <div class="note-small" id="view_note_${postCount}">
                5000 views = $1. +1000 = $0.2
            </div>
        </div>

        <!-- COMMENTS -->
        <div class="checkbox">
            <input type="checkbox" id="comment_${postCount}" onchange="toggleService(${postCount}, 'comment')"> Comments
        </div>
        <div id="comment_wrap_${postCount}" class="service-options" style="display:none;">
            <label>Number of Comments</label>
            <input type="number" id="comment_amount_${postCount}" min="10" value="10" 
                oninput="validateMin(${postCount}, 'comment'); updateTotal();">
            <div class="note-small" id="comment_note_${postCount}">
                10 comments = $3. +1 = $0.3<br>
                <b>Comments come from verified accounts, and the content will be reasonably relevant to your post.</b>
            </div>
        </div>

        <!-- LIKES -->
        <div class="checkbox">
            <input type="checkbox" id="like_${postCount}" onchange="toggleService(${postCount}, 'like')"> Likes
        </div>
        <div id="like_wrap_${postCount}" class="service-options" style="display:none;">
            <label>Number of Likes</label>
            <input type="number" id="like_amount_${postCount}" min="100" value="100" 
                oninput="validateMin(${postCount}, 'like'); updateTotal();">
            <div class="note-small" id="like_note_${postCount}">
                100 likes = $2. +10 = $0.2
            </div>
        </div>

        <!-- COMBO -->
        <div class="checkbox">
            <input type="checkbox" id="combo_${postCount}" onchange="toggleService(${postCount}, 'combo')"> 
            Combo (300 likes + 30 comments + 3000 views)
        </div>
        <div id="combo_wrap_${postCount}" class="service-options" style="display:none;">
            <label>Number of Combos</label>
            <input type="number" id="combo_amount_${postCount}" min="1" value="1" 
                oninput="validateMin(${postCount}, 'combo'); updateTotal();">
            <div class="note-small" id="combo_note_${postCount}">
                Each combo includes 300 likes, 30 comments, 3000 views from verified accounts.<br>
                Price: $14 per combo
            </div>
        </div>
    `;

    document.getElementById("posts_wrapper").appendChild(div);
    updateTotal();
}

addPostBox();

function toggleService(id, type) {
    document.getElementById(`${type}_wrap_${id}`).style.display =
        document.getElementById(`${type}_${id}`).checked ? "block" : "none";
    updateTotal();
}

function validateMin(id, type) {
    const input = document.getElementById(`${type}_amount_${id}`);
    const note = document.getElementById(`${type}_note_${id}`);
    const value = parseInt(input.value || 0);

    const MIN = { view: 5000, comment: 10, like: 100, combo: 1 };

    if (value < MIN[type]) {
        input.style.border = "2px solid red";
        note.style.color = "red";
        note.innerText = `Minimum is ${MIN[type]}`;
        return false;
    }

    input.style.border = "1px solid #ccc";
    note.style.color = "#555";
    return true;
}

function updateTotal() {
    let total = 0;

    for (let i = 1; i <= postCount; i++) {
        if (!document.getElementById(`post_${i}`)) continue;

        if (document.getElementById(`view_${i}`).checked) {
            let v = parseInt(document.getElementById(`view_amount_${i}`).value);
            if (v >= 5000) total += 1 + ((v - 5000) / 1000) * 0.2;
        }

        if (document.getElementById(`comment_${i}`).checked) {
            let c = parseInt(document.getElementById(`comment_amount_${i}`).value);
            if (c >= 10) total += 3 + (c - 10) * 0.3;
        }

        if (document.getElementById(`like_${i}`).checked) {
            let l = parseInt(document.getElementById(`like_amount_${i}`).value);
            if (l >= 100) total += 2 + ((l - 100) / 10) * 0.2;
        }

        if (document.getElementById(`combo_${i}`).checked) {
            let cb = parseInt(document.getElementById(`combo_amount_${i}`).value);
            if (cb >= 1) total += cb * 14;
        }
    }

    document.getElementById("total_price").innerText = total.toFixed(2);
    return total;
}

async function submitOrder() {

    const contact = document.getElementById("contact").value.trim();
    if (!contact) {
        alert("Please enter your contact (Email or X handle).");
        document.getElementById("contact").style.border = "2px solid red";
        return;
    } else {
        document.getElementById("contact").style.border = "1px solid #ccc";
    }

    const twitterRegex = /^https?:\/\/(x|twitter)\.com\/([A-Za-z0-9_]{1,50})\/status\/(\d+)$/;

    for (let i = 1; i <= postCount; i++) {
        const linkField = document.getElementById(`link_${i}`);
        const link = linkField.value.trim();

        // Check empty
        if (!link) {
            alert(`Post #${i}: Please enter a valid X/Twitter post link.`);
            linkField.style.border = "2px solid red";
            return;
        }

        // Check correct Twitter/X format
        if (!twitterRegex.test(link)) {
            alert(`Post #${i}: Invalid post link format. Must be a valid X/Twitter status URL.`);
            linkField.style.border = "2px solid red";
            return;
        }

        linkField.style.border = "1px solid #ccc";

        // Check at least one service selected
        const hasService =
            document.getElementById(`view_${i}`).checked ||
            document.getElementById(`comment_${i}`).checked ||
            document.getElementById(`like_${i}`).checked ||
            document.getElementById(`combo_${i}`).checked;

        if (!hasService) {
            alert(`Post #${i}: You must select at least one service.`);
            return;
        }

        // MIN checks
        if (document.getElementById(`view_${i}`).checked &&
            !validateMin(i, "view"))
            return alert(`Post #${i}: Views must be >= 5000`);

        if (document.getElementById(`comment_${i}`).checked &&
            !validateMin(i, "comment"))
            return alert(`Post #${i}: Comments must be >= 10`);

        if (document.getElementById(`like_${i}`).checked &&
            !validateMin(i, "like"))
            return alert(`Post #${i}: Likes must be >= 100`);

        if (document.getElementById(`combo_${i}`).checked &&
            !validateMin(i, "combo"))
            return alert(`Post #${i}: Combo must be >= 1`);
    }

    // Build posts array
    let posts = [];

    for (let i = 1; i <= postCount; i++) {
        posts.push({
            link: document.getElementById(`link_${i}`).value.trim(),
            views: document.getElementById(`view_${i}`).checked 
                ? parseInt(document.getElementById(`view_amount_${i}`).value) : 0,
            comments: document.getElementById(`comment_${i}`).checked 
                ? parseInt(document.getElementById(`comment_amount_${i}`).value) : 0,
            likes: document.getElementById(`like_${i}`).checked 
                ? parseInt(document.getElementById(`like_amount_${i}`).value) : 0,
            combo: document.getElementById(`combo_${i}`).checked 
                ? { 
                    count: parseInt(document.getElementById(`combo_amount_${i}`).value), 
                    price: 14 
                }
                : 0
        });
    }

    const body = {
        post_link: "MULTI",
        package: "multi",
        contact,
        note: JSON.stringify({ posts }),
        price: updateTotal()
    };

    const res = await fetch("/api/orders/create", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(body)
    });

    const data = await res.json();

    window.location.href = `/payment.html?id=${data.order.id}&t=${data.order.public_token}&amount=${updateTotal()}`;


}


</script>

</body>
</html>
