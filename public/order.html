<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Order Details</title>

    <style>
        body { font-family: Arial, sans-serif; background: #eef3f8; margin: 0; padding: 0; }
        .header { background: #007bff; color: white; padding: 18px; font-size: 22px; text-align: center; font-weight: bold; }
        .container { max-width: 700px; background: white; margin: 30px auto; padding: 25px; border-radius: 12px; box-shadow: 0 2px 12px rgba(0,0,0,0.1); }

        .row { margin-bottom: 18px; }
        .label { font-weight: bold; margin-bottom: 4px; display: block; color: #222; }
        .value { font-size: 16px; color: #444; }

        .status-box { padding: 12px; border-radius: 8px; font-weight: bold; display: inline-block; margin-top: 6px; }
        .status-pending { background: #fff3cd; color: #b58b00; }
        .status-paid_waiting { background: #cfe2ff; color: #084298; }
        .status-completed { background: #d1e7dd; color: #0f5132; }
        .status-unknown { background: #e2e3e5; color: #41464b; }

        .note-box { background: #fff7e6; padding: 12px; border-left: 4px solid #ffb84d; border-radius: 6px; white-space: pre-wrap; }

        .post-box { background: #f8f9fa; padding: 12px; border-radius: 8px; margin-top: 12px; }
        a { color: #007bff; word-break: break-all; }

        .footer { text-align: center; margin-top: 40px; color: #777; font-size: 14px; }
    </style>
</head>

<body>

<div class="header">Order Details</div>

<div class="container">

    <div class="row">
        <span class="label">Order ID:</span>
        <span id="orderId" class="value">...</span>
    </div>

    <div class="row">
        <span class="label">Status:</span>
        <span id="statusBox" class="status-box status-unknown">Loading...</span>
    </div>

    <div class="row">
        <span class="label">Total Amount:</span>
        <span id="amount" class="value">...</span> USDT
    </div>

    <div class="row">
        <span class="label">Contact:</span>
        <span id="contact" class="value">...</span>
    </div>

    <div class="row">
        <span class="label">Customer Note:</span>
        <div id="userNote" class="note-box">(No note)</div>
    </div>

    <div class="row">
        <span class="label">Posts:</span>
        <div id="posts"></div>
    </div>

</div>

<div class="footer">Website created by Toridochi</div>

<script>

function translateStatus(s) {
    switch (s) {
        case "pending_payment": return { text: "Waiting for Payment", css: "status-pending" };
        case "paid_waiting_confirmation": return { text: "Waiting for Seller Confirmation", css: "status-paid_waiting" };
        case "completed": return { text: "Completed", css: "status-completed" };
        default: return { text: s, css: "status-unknown" };
    }
}

async function loadOrder() {
    const url = new URL(window.location.href);
    const id = url.searchParams.get("id");
    const t  = url.searchParams.get("t");

    if (!id || !t) {
        document.getElementById("statusBox").innerText = "Invalid tracking link.";
        return;
    }

    const res = await fetch(`/api/orders/status?id=${id}&t=${t}`);
    let data;

    try { data = await res.json(); }
    catch { document.getElementById("statusBox").innerText = "Error loading order."; return; }

    if (!data.order) {
        document.getElementById("statusBox").innerText = "Order not found.";
        return;
    }

    const order = data.order;

    document.getElementById("orderId").innerText = order.id;
    document.getElementById("amount").innerText = order.price;
    document.getElementById("contact").innerText = order.contact;

    const statusInfo = translateStatus(order.status);
    const statusEl = document.getElementById("statusBox");
    statusEl.innerText = statusInfo.text;
    statusEl.className = `status-box ${statusInfo.css}`;

    // --- PARSE NOTE ---
    let noteData = {};
    try { noteData = JSON.parse(order.note || "{}"); }
    catch { noteData = {}; }

    // CUSTOMER NOTE
    const noteText =
    (noteData.user_note && noteData.user_note.trim() !== "")
        ? noteData.user_note
        : (noteData.customer_note && noteData.customer_note.trim() !== "")
            ? noteData.customer_note
            : "(No note)";

document.getElementById("userNote").innerText = noteText;

    // POSTS
    const postsBox = document.getElementById("posts");
    const posts = noteData.posts || [];
    postsBox.innerHTML = "";

    posts.forEach((p, i) => {
        postsBox.innerHTML += `
            <div class="post-box">
                <b>Post #${i+1}</b><br>
                <a href="${p.link}" target="_blank">${p.link}</a><br>
                ${p.views ? `Views: ${p.views}<br>` : ""}
                ${p.comments ? `Comments: ${p.comments}<br>` : ""}
                ${p.likes ? `Likes: ${p.likes}<br>` : ""}
                ${p.combo ? `Combo Packages: ${p.combo.count} Ã— 14 USDT<br>` : ""}
            </div>
        `;
    });

}

loadOrder();
</script>

</body>
</html>
