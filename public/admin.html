<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Admin Panel - Orders</title>

    <style>
        body {
            margin: 0;
            font-family: Arial, sans-serif;
            background: #eef2f7;
        }

        .header {
            background: #007bff;
            padding: 18px;
            color: white;
            font-size: 22px;
            text-align: center;
            font-weight: bold;
        }

        .container {
            max-width: 1100px;
            margin: 25px auto;
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .search-box input {
            width: 100%;
            padding: 12px;
            margin-bottom: 18px;
            border-radius: 8px;
            border: 1px solid #ccc;
            font-size: 15px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }

        th, td {
            padding: 12px;
            border-bottom: 1px solid #ddd;
            text-align: left;
            font-size: 15px;
            vertical-align: top;
        }

        th { background: #f5f5f5; }

        .status {
            padding: 6px 10px;
            border-radius: 8px;
            font-weight: bold;
            font-size: 13px;
            display: inline-block;
        }

        .pending_payment { background: #fff3cd; color: #927400; }
        .paid_waiting_confirmation { background: #cfe2ff; color: #084298; }
        .confirmed { background: #bfe7ff; color: #064270; }
        .completed { background: #d1e7dd; color: #0f5132; }
        .unknown { background: #e2e3e5; color: #41464b; }

        .btn {
            padding: 8px 14px;
            border-radius: 6px;
            cursor: pointer;
            border: none;
            font-size: 14px;
            margin-right: 5px;
        }

        .btn-confirm { background: #0d6efd; color: white; }
        .btn-complete { background: #198754; color: white; }
        .btn-refresh { background: #6c757d; color: white; margin-bottom: 10px; }

        .post-box {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 8px;
            margin-top: 6px;
        }

        .footer {
            text-align: center;
            margin-top: 35px;
            color: #777;
            font-size: 14px;
        }

        .note-box {
            background: #fff7e6;
            padding: 10px;
            border-left: 4px solid #ffb84d;
            border-radius: 6px;
            margin-bottom: 10px;
            white-space: pre-wrap;
        }

        .combo-box {
            background: #e6f7ff;
            padding: 10px;
            border-left: 4px solid #33aaff;
            border-radius: 6px;
            margin-bottom: 10px;
        }
    </style>
</head>

<body>

    <div class="header">Admin - Order Management</div>

    <div class="container">

        <button class="btn btn-refresh" onclick="loadOrders()">Refresh</button>

        <div class="search-box">
            <input type="text" id="search" placeholder="Search order ID, contact, or post link..." onkeyup="filterOrders()">
        </div>

        <table id="orderTable">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Status</th>
                    <th>Contact</th>
                    <th>Amount</th>
                    <th>Details</th>
                    <th>Actions</th>
                </tr>
            </thead>

            <tbody id="orderBody"></tbody>
        </table>

    </div>

    <div class="footer">Admin panel created by Toridochi</div>


<script>

const ADMIN_KEY = localStorage.getItem("ADMIN_TOKEN");
if (!ADMIN_KEY) window.location.href = "/admin-login.html";


function mapStatus(status) {
    switch (status) {
        case "pending_payment": 
            return { text: "Waiting for Payment", css: "pending_payment" };
        case "paid_waiting_confirmation":
            return { text: "Waiting for Confirmation", css: "paid_waiting_confirmation" };
        case "confirmed":
            return { text: "Confirmed", css: "confirmed" };
        case "completed":
            return { text: "Completed", css: "completed" };
        default:
            return { text: status, css: "unknown" };
    }
}

async function loadOrders() {
    const res = await fetch("/api/admin/orders", {
        headers: { "Authorization": "Bearer " + ADMIN_KEY }
    });

    const data = await res.json();
    const body = document.getElementById("orderBody");
    body.innerHTML = "";

    data.forEach(order => {
        
        // ----------- PARSE NOTE SAFE ------------
        let noteData = {};
        try { noteData = JSON.parse(order.note); } 
        catch { noteData = {}; }

        const userNote = noteData.user_note || "(No note)";
        const combo = noteData.combo || null;
        const posts = noteData.posts || [];

        // ----------- BUILD DETAILS HTML ----------
        let detailsHTML = `
            <div class="note-box"><b>Customer Note:</b><br>${userNote}</div>
        `;

        if (combo) {
            detailsHTML += `
                <div class="combo-box">
                    <b>Combo Selected:</b><br>
                    Count: ${combo.count}<br>
                    Price: ${combo.price} USDT
                </div>
            `;
        }

        posts.forEach((p, i) => {
            detailsHTML += `
                <div class="post-box">
                    <b>Post #${i+1}</b><br>
                    <a href="${p.link}" target="_blank">${p.link}</a><br>
                    ${p.views ? `Views: ${p.views}<br>` : ""}
                    ${p.comments ? `Comments: ${p.comments}<br>` : ""}
                    ${p.likes ? `Likes: ${p.likes}<br>` : ""}
                </div>
            `;
        });

        const st = mapStatus(order.status);

        body.innerHTML += `
            <tr>
                <td>${order.id}</td>
                <td><span class="status ${st.css}">${st.text}</span></td>
                <td>${order.contact}</td>
                <td>${order.price} USDT</td>
                <td>${detailsHTML}</td>
                <td>
                    <button class="btn btn-confirm" onclick="updateStatus(${order.id}, 'confirmed')">Confirm</button>
                    <button class="btn btn-complete" onclick="updateStatus(${order.id}, 'completed')">Complete</button>
                </td>
            </tr>
        `;
    });
}

async function updateStatus(id, status) {
    const res = await fetch("/api/admin/update", {
        method: "POST",
        headers: { 
            "Content-Type": "application/json",
            "Authorization": "Bearer " + ADMIN_KEY
        },
        body: JSON.stringify({ id, status })
    });

    if (res.ok) {
        alert("Status updated successfully!");
        loadOrders();
    } else {
        alert("Failed to update status.");
    }
}

function filterOrders() {
    let value = document.getElementById("search").value.toLowerCase();
    let rows = document.querySelectorAll("#orderBody tr");

    rows.forEach(row => {
        let text = row.innerText.toLowerCase();
        row.style.display = text.includes(value) ? "" : "none";
    });
}

loadOrders();

</script>

</body>
</html>
